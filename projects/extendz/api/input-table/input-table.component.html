<mat-toolbar>
  <button
    *ngIf="
      property.entityMeta?.config?.table == null &&
      property.entityMeta?.config?.table.enableAdd != false
    "
    class="mat-elevation-z0"
    mat-mini-fab
    color="primary"
    (click)="addRow()"
  >
    <mat-icon>
      <svg viewBox="0 0 24 24">
        <path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
      </svg>
    </mat-icon>
  </button>
</mat-toolbar>
<form [formGroup]="formGroup">
  <table mat-table [dataSource]="dataSource" formArrayName="data" fixedLayout="true">
    <ng-container
      *ngFor="let p of property.entityMeta.properties | keyvalue"
      [matColumnDef]="p.key"
    >
      <th mat-header-cell *matHeaderCellDef [fxFlex.lg]="p.value?.width?.lg">
        {{ p.value?.displayName || p.key | camelCase }}
      </th>

      <td
        mat-cell
        *matCellDef="let e; let i = index"
        [formGroupName]="i"
        [fxFlex.lg]="p.value?.width?.lg"
      >
        <span [ngSwitch]="p?.value?.type">
          <span *ngSwitchCase="'index'">
            {{ i + 1 }}
            <input style="display: none" [formControlName]="p?.value?.name" />
          </span>

          <!-- number -->
          <mat-form-field *ngSwitchCase="'number'">
            <input type="number" matInput autocomplete="off" [formControlName]="p?.value?.name" />
            <mat-error *ngIf="formGroup.controls[p?.value?.name]?.hasError('required')">
              {{ p?.value?.name | camelCase }} is <strong>required!</strong>
            </mat-error>
          </mat-form-field>

          <!-- display -->
          <span *ngSwitchCase="'display'">
            <input style="outline: none; border: none" [formControlName]="p?.value?.name" />
          </span>

          <!-- Money -->
          <mat-form-field *ngSwitchCase="'money'">
            <ext-money [property]="p.value" [formControlName]="p?.value?.name"></ext-money>
            <!-- <mat-error *ngIf="formGroup.controls[p?.value?.name].hasError('required')">
              {{ p?.value?.name | camelCase }} is <strong>required!</strong>
            </mat-error> -->
          </mat-form-field>

          <!-- Sting -->
          <mat-form-field *ngSwitchCase="'string'">
            <input type="text" matInput autocomplete="off" [formControlName]="p?.value?.name" />
            <mat-error *ngIf="formGroup.controls[p?.value?.name]?.hasError('required')">
              {{ p?.value?.name | camelCase }} is
              <strong>required</strong>
            </mat-error>
          </mat-form-field>

          <!-- enum -->
          <mat-form-field *ngSwitchCase="'enum'">
            <mat-select [formControlName]="p.value.name">
              <mat-option *ngFor="let enum of p.value.enums" [value]="enum">
                {{ enum }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Date -->
          <mat-form-field *ngSwitchCase="'date'">
            <input
              matInput
              autocomplete="off"
              [matDatepicker]="picker"
              [formControlName]="p.value.name"
            />
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker [touchUi]="media.isActive('xs')" #picker></mat-datepicker>
            <mat-error *ngIf="formGroup.controls[p?.value?.name]?.hasError('required')">
              {{ p?.value?.name | camelCase }} is
              <strong>required</strong>
            </mat-error>
          </mat-form-field>

          <!-- object -->
          <mat-form-field *ngSwitchCase="'object'">
            <ext-select
              (entityChange)="onSelectionChange($event, p?.value, i)"
              [property]="p.value"
              [formControlName]="p.value.name"
            >
            </ext-select>
          </mat-form-field>

          <span *ngSwitchCase="'action'">
            <button mat-icon-button (click)="onOperation(p.value, i)">
              <mat-icon class="primary" svgIcon="api-root:{{ p.value?.icon }}"></mat-icon>
            </button>
          </span>
        </span>
      </td>
    </ng-container>

    <mat-header-row *matHeaderRowDef="allColumns"></mat-header-row>
    <mat-row *matRowDef="let row; columns: allColumns"></mat-row>
  </table>
</form>
